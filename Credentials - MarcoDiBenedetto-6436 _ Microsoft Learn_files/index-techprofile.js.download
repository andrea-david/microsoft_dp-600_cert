"use strict";

(() => {
    // Helper per la gestione delle proprietà private e classi
    var Aoe = Object.defineProperty;
    var yi = (e, t, o) => t in e ? Aoe(e, t, { enumerable: !0, configurable: !0, writable: !0, value: o }) : e[t] = o;

    /**
     * Inizializza la gestione dei menu a cascata (Popover)
     * Gestisce l'apertura, il posizionamento dinamico e la chiusura al clic esterno
     */
    function initPopovers(container = document.body) {
        container.addEventListener("toggle", event => {
            let popover = event.target instanceof Element && event.target.closest("details.popover");
            if (!popover) return;

            let content = popover.querySelector(".popover-content");
            if (!content) return;

            // Se il menu viene chiuso, nascondilo
            if (!popover.open) {
                content.style.visibility = "hidden";
                return;
            }

            // Se viene aperto, calcola la posizione
            requestAnimationFrame(() => {
                updatePopoverPosition(popover);
                content.offsetHeight; // Trigger reflow
            });

            // Funzioni di chiusura
            const closePopover = () => {
                if (popover?.open) {
                    popover.removeAttribute("open");
                    content.style.visibility = "hidden";
                }
                cleanupListeners();
            };

            const handleOutsideInteraction = (e) => {
                if (e.target instanceof Element && !popover.contains(e.target)) {
                    closePopover();
                }
            };

            const handleEsc = (e) => { if (e.key === "Escape") closePopover(); };

            const cleanupListeners = () => {
                container.removeEventListener("click", handleOutsideInteraction);
                container.removeEventListener("keydown", handleEsc);
                window.removeEventListener("resize", updatePopoverPosition);
            };

            // Aggiungi listener per chiudere il menu
            container.addEventListener("click", handleOutsideInteraction);
            container.addEventListener("keydown", handleEsc);
            window.addEventListener("resize", () => updatePopoverPosition(popover));

        }, true);
    }

    // --- Funzioni di calcolo posizionamento ---
    function updatePopoverPosition(popover) {
        let content = popover.querySelector(".popover-content");
        let summary = popover.querySelector("summary");
        if (!content || !summary) return;

        content.style.top = "";
        content.style.left = "";
        
        let rect = summary.getBoundingClientRect();
        let spaceBelow = window.innerHeight - rect.bottom;
        let contentHeight = content.offsetHeight;

        // Se non c'è spazio sotto, mostra sopra
        if (spaceBelow < contentHeight && rect.top > contentHeight) {
            content.style.top = `${summary.offsetTop - contentHeight - 8}px`;
        } else {
            content.style.top = `${summary.offsetTop + rect.height + 8}px`;
        }

        content.style.visibility = "visible";
    }

    // Avvia la gestione dei menu al caricamento del DOM
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => initPopovers());
    } else {
        initPopovers();
    }
})();